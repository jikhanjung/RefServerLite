# 백그라운드 작업 모니터링 대시보드 구현 계획

## 1. 개요

이 문서는 RefServerLite 백그라운드에서 실행되는 문서 처리 작업(`ProcessingJob`)의 현재 상태, 진행률, 대기열 등을 실시간으로 모니터링할 수 있는 대시보드 화면을 구현하기 위한 계획을 상세히 기술합니다. 이를 통해 관리자는 시스템의 작업 부하와 개별 문서 처리 상태를 직관적으로 파악할 수 있습니다.

## 2. 목표

*   현재 진행 중인 작업, 대기 중인 작업, 완료된 작업, 실패한 작업 목록을 표시합니다.
*   각 작업의 진행 상태(%) 및 현재 단계(`current_step`)를 실시간으로 업데이트하여 보여줍니다.
*   실패한 작업의 경우, 오류 메시지를 확인할 수 있도록 합니다.
*   관리자가 작업 목록을 필터링하고 정렬할 수 있도록 합니다.
*   (선택 사항) 특정 작업에 대한 상세 정보를 볼 수 있는 기능을 제공합니다.

## 3. 고수준 계획

1.  **Phase 1: 백엔드 API 개발**: `ProcessingJob` 데이터를 조회할 수 있는 RESTful API 엔드포인트를 구현합니다.
2.  **Phase 2: 프론트엔드 UI 구현**: API를 통해 데이터를 가져와 사용자 친화적인 대시보드 화면을 구성합니다.
3.  **Phase 3: 통합 및 테스트**: 백엔드와 프론트엔드를 통합하고, 기능 및 안정성을 테스트합니다.

## 4. 상세 구현 계획

### Phase 1: 백엔드 API 개발

**목표**: `ProcessingJob` 모델의 데이터를 효율적으로 조회할 수 있는 API를 제공합니다.

*   **파일**: `app/main.py`

*   **신규 엔드포인트**: `/api/v1/jobs`
    *   **메서드**: `GET`
    *   **기능**: 모든 `ProcessingJob` 목록을 반환합니다.
    *   **쿼리 파라미터 (선택 사항)**:
        *   `status`: 특정 상태의 작업만 필터링 (예: `processing`, `uploaded`, `completed`, `failed`)
        *   `limit`, `offset`: 페이지네이션을 위한 파라미터
        *   `order_by`: 정렬 기준 (예: `created_at`, `status`)
    *   **응답**: `ProcessingJob` 객체 목록 (JSON 형식)
    *   **인증**: 관리자 권한(`Depends(get_current_user)`)이 필요합니다.

*   **신규 엔드포인트**: `/api/v1/jobs/{job_id}`
    *   **메서드**: `GET`
    *   **기능**: 특정 `job_id`에 해당하는 `ProcessingJob`의 상세 정보를 반환합니다.
    *   **응답**: 단일 `ProcessingJob` 객체 (JSON 형식)
    *   **인증**: 관리자 권한이 필요합니다.

*   **구현 로직**: `ProcessingJob` 모델을 사용하여 데이터베이스에서 작업을 조회하고, 필요한 필드만 포함하여 JSON 응답을 구성합니다. `peewee` 쿼리를 사용하여 필터링, 정렬, 페이지네이션을 구현합니다.

### Phase 2: 프론트엔드 UI 구현

**목표**: 백엔드 API를 활용하여 작업 상태를 시각적으로 보여주는 대시보드를 만듭니다.

*   **파일**: `app/templates/admin_jobs.html` (신규 파일) 또는 `app/templates/admin.html`에 섹션 추가
    *   **권장**: 초기에는 `admin.html`에 새로운 섹션을 추가하여 기존 관리자 대시보드와 통합하는 것이 효율적입니다. 추후 기능이 복잡해지면 별도 페이지로 분리합니다.

*   **`app/main.py` 수정**: `/admin` 엔드포인트에서 `admin_jobs.html` (또는 `admin.html`에 추가된 섹션)을 렌더링하도록 수정합니다.

*   **`app/static/js/script.js` (또는 신규 JS 파일) 수정**: 
    *   **데이터 가져오기**: `/api/v1/jobs` 엔드포인트에 AJAX 요청(Fetch API 또는 Axios)을 보냅니다.
    *   **자동 새로고침**: `setInterval`을 사용하여 주기적으로(예: 5초마다) API를 호출하여 데이터를 업데이트합니다.
    *   **테이블 렌더링**: 가져온 작업 목록을 HTML 테이블 형태로 동적으로 생성하거나 업데이트합니다.
    *   **진행률 표시**: `progress_percentage`를 사용하여 진행 바(CSS 또는 간단한 텍스트)를 표시합니다.
    *   **오류 메시지**: 실패한 작업의 경우 `error_message`를 표시하고, 클릭 시 상세 내용을 볼 수 있도록 합니다.
    *   **필터링/정렬**: 드롭다운 메뉴나 버튼을 통해 작업 상태별 필터링 및 정렬 기능을 구현합니다.

*   **`app/static/css/style.css` 수정**: 대시보드 테이블 및 진행 바, 상태 표시를 위한 CSS 스타일을 추가합니다.

### Phase 3: 통합 및 테스트

**목표**: 구현된 기능이 올바르게 작동하고 안정적인지 확인합니다.

*   **통합 테스트**: 
    *   PDF 업로드 -> 작업 생성 -> 백그라운드 처리 -> 대시보드에서 상태 변화 확인
    *   다수의 PDF를 동시에 업로드하여 대기열 및 동시 처리 상태 확인
    *   작업 실패 시 오류 메시지 표시 확인
*   **성능 테스트**: 대량의 작업이 있을 때 대시보드의 응답 속도 및 UI 성능을 모니터링합니다.
*   **에러 핸들링**: API 호출 실패, 데이터 파싱 오류 등 다양한 예외 상황에 대한 프론트엔드의 견고성을 테스트합니다.
*   **보안**: 관리자 권한이 없는 사용자가 API에 접근할 수 없는지 확인합니다.

## 5. 고려 사항

*   **실시간 업데이트 방식**: 현재는 `setInterval`을 통한 폴링(polling) 방식이 제안되었으나, 더 많은 실시간성이 요구될 경우 WebSocket(`FastAPI-WebSocket`) 도입을 고려할 수 있습니다. (초기 구현에서는 폴링으로 충분)
*   **데이터 양**: 작업 수가 매우 많아질 경우, API의 페이지네이션 및 프론트엔드의 효율적인 데이터 렌더링이 중요해집니다.
*   **작업 제어**: (향후 확장) 대시보드에서 작업 취소, 재시도, 우선순위 변경 등의 기능을 추가할 수 있습니다.
*   **로그 통합**: 작업별 상세 로그를 대시보드에서 직접 볼 수 있도록 로그 시스템과 연동하는 방안을 고려할 수 있습니다.
*   **`ProcessingJob` 관리 방식 개선 (장기적)**: 현재 `ProcessingJob`은 SQLite DB를 폴링하여 관리되지만, 시스템 확장 시 동시성 및 성능 문제가 발생할 수 있습니다. 향후 Redis (또는 Celery와 같은 분산 태스크 큐 프레임워크)를 도입하여 작업 생성자와 소비자를 분리하고, 작업 관리의 안정성, 확장성, 유연성(재시도, 우선순위 큐 등)을 확보하는 것을 고려할 수 있습니다. 이는 메인 DB의 부하를 줄이는 데도 기여합니다.

## 6. 구현 우선순위

1.  **1순위**: `ProcessingJob` 목록을 반환하는 `/api/v1/jobs` GET 엔드포인트 구현 (필터링/정렬 제외).
2.  **2순위**: `admin.html`에 작업 목록을 표시하는 테이블과 자동 새로고침 기능 구현.
3.  **3순위**: `/api/v1/jobs` 엔드포인트에 필터링 및 정렬 기능 추가.
4.  **4순위**: `/api/v1/jobs/{job_id}` 상세 정보 엔드포인트 및 프론트엔드 상세 보기 기능 구현.

이 계획에 따라 백그라운드 작업 모니터링 대시보드를 구현할 수 있습니다.
